#!/bin/bash
set -x
# Register and reset qemu for multi arch building
echo "=-=-=-=-= Build Setup =-=-=-=-="
docker buildx version
docker buildx ls
docker buildx create --name multiarch --driver docker-container --use
docker buildx inspect --bootstrap --builder multiarch

# Define the build arguments
echo "=-=-=-=-= Build Arguments =-=-=-=-="
echo "DOCKER_REPO=$DOCKER_REPO" >> $BUILDKITE_ENV_FILE
echo "IMAGE_NAME=$IMAGE_NAME" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_NUMBER=$BUILDKITE_BUILD_NUMBER" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_URL=$BUILDKITE_BUILD_URL" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_COMMIT=$BUILDKITE_COMMIT" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_MESSAGE=$BUILDKITE_MESSAGE" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_TAG=$BUILDKITE_TAG" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BRANCH=$BUILDKITE_BRANCH" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR=$BUILDKITE_BUILD_CREATOR" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR_EMAIL=$BUILDKITE_BUILD_CREATOR_EMAIL" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR_TEAMS=$BUILDKITE_BUILD_CREATOR_TEAMS" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR_TEAMS_SLUGS=$BUILDKITE_BUILD_CREATOR_TEAMS_SLUGS" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR_TEAMS_IDS=$BUILDKITE_BUILD_CREATOR_TEAMS_IDS" >> $BUILDKITE_ENV_FILE
echo "BUILDKITE_BUILD_CREATOR_TEAMS_NAMES=$BUILDKITE_BUILD_CREATOR_TEAMS_NAMES" >> $BUILDKITE_ENV_FILE

echo "=-=-=-=-= START DEBUG =-=-=-=-="
echo ""
echo "=-=-=-=-= Variables =-=-=-=-="
echo "DOCKER_REPO: ${DOCKER_REPO}"
echo "IMAGE_NAME: ${IMAGE_NAME}"
echo "IMAGE_NAME#index.docker.io ${IMAGE_NAME#index.docker.io/}"
echo "SOURCE_BRANCH: ${SOURCE_BRANCH}"
echo "SOURCE_COMMIT: ${SOURCE_COMMIT}"
echo "COMMIT_MSG: ${COMMIT_MSG}"
echo "DOCKER_REPO: ${DOCKER_REPO}"
echo "DOCKERFILE_PATH: ${DOCKERFILE_PATH}"
echo "DOCKER_TAG: ${DOCKER_TAG}"
echo "IMAGE_NAME: ${IMAGE_NAME}"

echo "=-=-=-=-= ENV =-=-=-=-="
echo $ENV

echo "=-=-=-=-= BUILDKITE_ENV_FILE =-=-=-=-="
cat $BUILDKITE_ENV_FILE

echo "=-=-=-=-= END DEBUG =-=-=-=-="
